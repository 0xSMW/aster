# fswalk benchmark

Filesystem traversal benchmark that counts files, directories, and total bytes
under a root path using real on-disk data. The harness runs two modes when
`FS_BENCH_ROOT` is set:
- `fswalk`: list/replay mode (fixed path list + stat/lstat)
- `treewalk`: live traversal mode (fts on Aster/C++, manual stack on Rust)
- `dircount`: live traversal count-only mode (no size accumulation)
- `fsinventory`: live traversal inventory (counts files/dirs/symlinks + name hash)
- `treewalk` list mode: prelisted directories enumerated non-recursively (set `FS_BENCH_TREEWALK_LIST`)

## Usage
Set the root path via environment variable and run the bench harness. The
benchmark harness will generate a replay list automatically if one is not
provided. You can also split kernel and fswalk runs to reduce cache effects.

```
FS_BENCH_ROOT=/path/to/root FS_BENCH_MAX_DEPTH=6 tools/bench/run.sh
```

Run fswalk + treewalk only:

```
FS_BENCH_ROOT=/path/to/root BENCH_SET=fswalk tools/bench/run.sh
```

Run kernels only:

```
BENCH_SET=kernels tools/bench/run.sh
```

Shortcuts:

```
tools/bench/run_kernels.sh
tools/bench/run_fswalk.sh /path/to/root
```

## List mode (replay)
Generate a fixed list of paths to decouple traversal from stat overhead:

```
tools/bench/fswalk_list.sh /path/to/root /tmp/fswalk.list 6
FS_BENCH_LIST=/tmp/fswalk.list tools/bench/run.sh
```

Environment variables:
- FS_BENCH_ROOT: required to enable this benchmark.
- FS_BENCH_MAX_DEPTH: max traversal depth (default 6). Depth 0 is the root.
- FS_BENCH_CPP_MODE: "fts" or "bulk" to use fts/getattrlistbulk traversal in C++ (default std::filesystem).
- FS_BENCH_LIST: path to newline-delimited list of paths to stat.
- FS_BENCH_LIST_PATH: internal path generated by the harness for list mode.
- FS_BENCH_LIST_FIXED: set to 1 to use tools/bench/data/fswalk_list.txt when present.
- FS_BENCH_IO_RUNS: override runs for fs benches (alias: FS_BENCH_FSWALK_RUNS) (default 3).
- FS_BENCH_IO_WARMUP: override warmup runs for fs benches (alias: FS_BENCH_FSWALK_WARMUP) (default 0).
- FS_BENCH_TREEWALK_MODE: "bulk" to use getattrlistbulk in Aster treewalk (default fts in code; harness defaults to bulk).
- FS_BENCH_INVENTORY: set to 1 to enable inventory hashing and symlink counting (used by fsinventory).
- FS_BENCH_BULK_BUF: override getattrlistbulk buffer size in bytes (default 8388608).
- FS_BENCH_BULK_PACK: set to 0 to disable FSOPT_PACK_INVAL_ATTRS (default 1).
- FS_BENCH_BULK_NOINMEM: set to 1 to enable FSOPT_NOINMEMUPDATE (default 0).
- FS_BENCH_COUNT_ONLY: set to 1 to skip byte accumulation (used by dircount).
- FS_BENCH_TREEWALK_LIST: path to newline-delimited list of directory roots to enumerate.
- FS_BENCH_TREEWALK_LIST_FIXED: set to 1 to use tools/bench/data/treewalk_dirs.txt when present.
- FS_BENCH_PROFILE: set to 1 to print Aster timing breakdown for bulk traversal (getattrlistbulk/parse/openat).

Notes:
- Uses real filesystem data; results depend on cache state and disk speed.
- If FS_BENCH_ROOT is not set, the benchmark is skipped.
- Fixed dataset lives at tools/bench/data/fswalk_list.txt with metadata in tools/bench/data/fswalk_list.meta.
