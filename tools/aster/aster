#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"

source "$ROOT/tools/aster/modules.sh"

usage() {
  cat >&2 <<'TXT'
usage: tools/aster/aster <cmd> [args...]

cmd:
  build <path.as|project_dir> [out]
  run   <path.as|project_dir> [-- args...]
  test
  bench [bench_args...]

env:
  ASTER_COMPILER      path to tools/build/out/asterc (default: repo)
  ASTER_CACHE=1       enable content-hash build cache for `build`/`run`
  ASTER_CACHE_DIR     cache root (default: .context/aster/cache)
TXT
}

resolve_entry() {
  local path="$1"
  if [[ -d "$path" ]]; then
    if [[ -f "$path/src/main.as" ]]; then
      printf '%s\n' "$path/src/main.as"
      return 0
    fi
    echo "aster: missing src/main.as in project dir: $path" >&2
    exit 2
  fi
  printf '%s\n' "$path"
}

do_build() {
  local path="$1"
  local out="${2:-}"

  local entry
  entry="$(resolve_entry "$path")"
  if [[ ! -f "$entry" ]]; then
    echo "aster: entry not found: $entry" >&2
    exit 2
  fi

  local root_dir
  root_dir="$(aster_find_root "$(cd "$(dirname "$entry")" && pwd)")"

  local out_bin
  if [[ -n "$out" ]]; then
    out_bin="$out"
  else
    base="$(basename "$entry" .as)"
    out_bin="$ROOT/.context/aster/build/out/$base"
  fi

  local cache_root="${ASTER_CACHE_DIR:-$ROOT/.context/aster/cache}"
  mkdir -p "$cache_root"

  local asterc="${ASTER_COMPILER:-$ROOT/tools/build/out/asterc}"
  if [[ ! -x "$asterc" ]]; then
    bash "$ROOT/tools/build/build.sh" "$ROOT/asm/driver/asterc.S" >/dev/null
  fi

  # Preprocess modules into a combined source.
  local tmp_root="$ROOT/.context/aster/build/tmp"
  mkdir -p "$tmp_root"
  local combined="$tmp_root/combined.as"
  aster_preprocess_modules "$root_dir" "$entry" "$combined"

  if [[ -n "${ASTER_CACHE:-}" && "${ASTER_CACHE}" != "0" ]]; then
    src_sha="$(shasum -a 256 "$combined" | awk '{print $1}')"
    cc_sha="$(shasum -a 256 "$asterc" | awk '{print $1}')"
    key="${src_sha}_${cc_sha}"
    ent="$cache_root/$key"
    if [[ -x "$ent/out" ]]; then
      mkdir -p "$(dirname "$out_bin")"
      cp -f "$ent/out" "$out_bin"
      if [[ -f "$ent/out.ll" ]]; then
        cp -f "$ent/out.ll" "${out_bin}.ll"
      fi
      echo "built (cache) $out_bin"
      return 0
    fi
    mkdir -p "$ent"
    "$ROOT/tools/build/asterc.sh" "$combined" "$ent/out"
    mkdir -p "$(dirname "$out_bin")"
    cp -f "$ent/out" "$out_bin"
    if [[ -f "$ent/out.ll" ]]; then
      cp -f "$ent/out.ll" "${out_bin}.ll"
    fi
    echo "built $out_bin"
    return 0
  fi

  mkdir -p "$(dirname "$out_bin")"
  "$ROOT/tools/build/asterc.sh" "$combined" "$out_bin"
  echo "built $out_bin"
}

do_run() {
  local path="$1"
  shift
  local out="$ROOT/.context/aster/run/bin"
  do_build "$path" "$out"
  exec "$out" "$@"
}

cmd="${1:-}"
if [[ -z "$cmd" ]]; then
  usage
  exit 2
fi
shift || true

case "$cmd" in
  build)
    if [[ $# -lt 1 || $# -gt 2 ]]; then usage; exit 2; fi
    do_build "$@"
    ;;
  run)
    if [[ $# -lt 1 ]]; then usage; exit 2; fi
    path="$1"; shift
    if [[ "${1:-}" == "--" ]]; then shift; fi
    do_run "$path" "$@"
    ;;
  test)
    bash "$ROOT/aster/tests/run.sh"
    ;;
  bench)
    # Convenience flags (translate to env vars consumed by tools/bench/run.sh).
    while [[ $# -gt 0 ]]; do
      case "$1" in
        --kernels)
          export BENCH_SET=kernels
          shift
          ;;
        --fswalk)
          export BENCH_SET=fswalk
          shift
          ;;
        --all)
          export BENCH_SET=all
          shift
          ;;
        --fs-root)
          export FS_BENCH_ROOT="${2:?missing arg to --fs-root}"
          shift 2
          ;;
        --max-depth)
          export FS_BENCH_MAX_DEPTH="${2:?missing arg to --max-depth}"
          shift 2
          ;;
        --list-fixed)
          export FS_BENCH_LIST_FIXED=1
          export FS_BENCH_TREEWALK_LIST_FIXED=1
          export FS_BENCH_STRICT=1
          shift
          ;;
        --treewalk-mode)
          export FS_BENCH_TREEWALK_MODE="${2:?missing arg to --treewalk-mode}"
          shift 2
          ;;
        --cpp-mode)
          export FS_BENCH_CPP_MODE="${2:?missing arg to --cpp-mode}"
          shift 2
          ;;
        --build-timing)
          export BENCH_BUILD_TIMING=1
          shift
          ;;
        --)
          shift
          break
          ;;
        *)
          break
          ;;
      esac
    done
    bash "$ROOT/tools/bench/run.sh"
    ;;
  -h|--help|help)
    usage
    ;;
  *)
    echo "aster: unknown cmd: $cmd" >&2
    usage
    exit 2
    ;;
esac
